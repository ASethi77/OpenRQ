<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!--
Copyright 2014 Jose Lopes

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<project name="junit-ant">
    <description>
        Ant build file for building self-contained JUnit Jar.
        This script is intended to be imported from a top-level script.
    </description>

    <!-- 
        When this file is imported the basedir property is ignored,
        so this hack is required to retrieve it.
    -->
    <dirname property="junit-ant.basedir" file="${ant.file.junit-ant}"/>

    <property name="junit-core.jar" location="${junit-ant.basedir}/junit-4.11.jar"/>
    <property name="hamcrest-core.jar" location="${junit-ant.basedir}/hamcrest-core-1.3.jar"/>

    <!-- private target to be overriden in importing script -->
    <target name="-init-junit-properties">
    
        <echo>The following properties may or must be defined ([&lt;prop&gt;] means optional):
        junit.src_dir        : path to the source files to be compiled along with JUnit
        junit.bin_dir        : path to the compiled files (JUnit included)
        junit.jar_file       : path to the resulting self-contained executable Jar
        [junit.extrabin_dir] : extra directory containing class files to be included in the build
        </echo>
        <fail message="Must define JUnit properties.">
            <condition>
                <not>
                    <and>
                        <isset property="junit.src_dir"/>
                        <isset property="junit.bin_dir"/>
                        <isset property="junit.jar_file"/>
                    </and>
                </not>
            </condition>
        </fail>
        
    </target>
    

    <!-- private target to be called by importing script -->
    <target name="-junit-jar" depends="-init-junit-properties,-simple-junit-jar,-extra-junit-jar"/>

    <target name="-compile-with-junit">
        
        <delete dir="${junit.bin_dir}"/>
        <mkdir dir="${junit.bin_dir}"/>
        
        <javac srcdir="${junit.src_dir}" destdir="${junit.bin_dir}"
               classpath="${junit-core.jar}:${hamcrest-core.jar}:${junit.extrabin_dir}"
               includeAntRuntime="false"/>
               
    </target>

    <target name="-simple-junit-jar" depends="-compile-with-junit" unless="junit.extrabin_dir">
        
        <delete file="${junit.jar_file}"/>
        <jar jarfile="${junit.jar_file}" basedir="${junit.bin_dir}">
            <manifest>
                <attribute name="Main-Class" value="org.junit.runner.JUnitCore"/>
            </manifest>
            
            <zipfileset src="${junit-core.jar}" />
            <zipfileset src="${hamcrest-core.jar}" />
        </jar>
        
    </target>

    <target name="-extra-junit-jar" depends="-compile-with-junit" if="junit.extrabin_dir">
    
        <delete file="${junit.jar_file}"/>
        <jar jarfile="${junit.jar_file}" basedir="${junit.bin_dir}">
            <fileset dir="${junit.extrabin_dir}"/>
            
            <manifest>
                <attribute name="Main-Class" value="org.junit.runner.JUnitCore"/>
            </manifest>
            
            <zipfileset src="${junit-core.jar}" />
            <zipfileset src="${hamcrest-core.jar}" />
        </jar>
    
    </target>
    
</project>
